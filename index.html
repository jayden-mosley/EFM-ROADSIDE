<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vehicle Log System</title>

<!-- Firebase SDKs (NO npm, NO import) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 20px;
}
h1, h2 { margin: 20px 0 10px; }
form {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    background: #fff;
    padding: 15px;
    border-radius: 6px;
}
form input, form textarea {
    flex: 1 1 200px;
    padding: 8px;
}
form textarea { min-height: 60px; }
form button {
    flex: 1 1 100%;
    padding: 10px;
    background: #007bff;
    color: white;
    border: none;
}
#logs {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.log {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    background: #fff;
    padding: 15px;
    border-radius: 6px;
    border-left: 5px solid #007bff;
}
.log-details {
    flex: 3;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 5px 15px;
    font-size: 0.9em;
}
.log-timer {
    flex: 1;
    text-align: center;
}
.timer { font-weight: bold; color: #c00; }
.laps { font-size: 0.85em; color: #555; }
.log button {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px;
}
.actions {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.download { background: #007bff; color: white; }
.reset { background: #dc3545; color: white; }
table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
    font-size: 0.9em;
}
th { background: #eee; }
</style>
</head>

<body>

<h1>Vehicle Log System</h1>

<form id="logForm">
    <input id="date" type="date" required>
    <input id="store" placeholder="Store No" required>
    <input id="name" placeholder="Name" required>
    <input id="reg" placeholder="Reg No" required>
    <input id="supplier" placeholder="Supplier" required>
    <textarea id="defect" placeholder="What is wrong with van?" required></textarea>
    <textarea id="solution" placeholder="Solution?" required></textarea>
    <button type="submit">Add Log</button>
</form>

<h2>Active Logs</h2>
<div id="logs"></div>

<h2>Completed Jobs</h2>
<div class="actions">
    <button class="download" onclick="downloadCSV()">Download Excel (CSV)</button>
    <button class="reset" onclick="resetCompletedJobs()">Reset Completed Jobs</button>
</div>

<table>
<thead>
<tr>
    <th>Date</th>
    <th>Store</th>
    <th>Name</th>
    <th>Reg</th>
    <th>Supplier</th>
    <th>Defect</th>
    <th>Solution</th>
    <th>Completed</th>
</tr>
</thead>
<tbody id="completedTable"></tbody>
</table>

<audio id="alarmSound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
/* ---------- FIREBASE INIT ---------- */
firebase.initializeApp({
  apiKey: "AIzaSyAqSeC_7pZHIOCKzVaBXX2-b3IpouECXJI",
  authDomain: "efm-roadside.firebaseapp.com",
  databaseURL: "https://efm-roadside-default-rtdb.firebaseio.com",
  projectId: "efm-roadside",
  storageBucket: "efm-roadside.appspot.com",
  messagingSenderId: "420379390452",
  appId: "1:420379390452:web:75f977da10fd84526589a1"
});

const db = firebase.database();

/* ---------- GLOBALS ---------- */
const logsDiv = document.getElementById("logs");
const completedTable = document.getElementById("completedTable");
const alarmSound = document.getElementById("alarmSound");

let completedJobs = [];

/* ---------- SYNC COMPLETED JOBS ---------- */
db.ref("completedJobs").on("value", snapshot => {
    completedJobs = [];
    completedTable.innerHTML = "";

    snapshot.forEach(child => {
        const job = child.val();
        completedJobs.push(job);
        addCompletedRow(job);
    });
});

/* ---------- FORM ---------- */
document.getElementById("logForm").addEventListener("submit", e => {
    e.preventDefault();

    createLog({
        date: date.value,
        store: store.value,
        name: name.value,
        reg: reg.value,
        supplier: supplier.value,
        defect: defect.value,
        solution: solution.value,
        laps: 0
    });

    e.target.reset();
});

/* ---------- ACTIVE LOG ---------- */
function createLog(log) {
    const card = document.createElement("div");
    card.className = "log";

    const details = document.createElement("div");
    details.className = "log-details";
    details.innerHTML = `
        <div><strong>Date:</strong> ${log.date}</div>
        <div><strong>Store:</strong> ${log.store}</div>
        <div><strong>Name:</strong> ${log.name}</div>
        <div><strong>Reg:</strong> ${log.reg}</div>
        <div><strong>Supplier:</strong> ${log.supplier}</div>
        <div><strong>Issue:</strong> ${log.defect}</div>
        <div><strong>Solution:</strong> ${log.solution}</div>
    `;

    const timerBox = document.createElement("div");
    const timer = document.createElement("div");
    timer.className = "timer";
    const laps = document.createElement("div");
    laps.className = "laps";
    laps.textContent = "30min checks: 0";

    let startTime = Date.now();
    const interval = setInterval(() => {
        let remaining = 1800000 - (Date.now() - startTime);
        if (remaining <= 0) {
            log.laps++;
            laps.textContent = `30min checks: ${log.laps}`;
            alarmSound.play();
            startTime = Date.now();
            remaining = 1800000;
        }
        const m = Math.floor(remaining / 60000);
        const s = Math.floor((remaining % 60000) / 1000);
        timer.textContent = `${m}:${s.toString().padStart(2, "0")}`;
    }, 1000);

    const btn = document.createElement("button");
    btn.textContent = "Complete";
    btn.onclick = () => {
        clearInterval(interval);
        db.ref("completedJobs").push({
            ...log,
            completedTime: new Date().toLocaleString()
        });
        card.remove();
    };

    timerBox.append(timer, laps, btn);
    card.append(details, timerBox);
    logsDiv.appendChild(card);
}

/* ---------- TABLE ---------- */
function addCompletedRow(job) {
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${job.date}</td>
        <td>${job.store}</td>
        <td>${job.name}</td>
        <td>${job.reg}</td>
        <td>${job.supplier}</td>
        <td>${job.defect}</td>
        <td>${job.solution}</td>
        <td>${job.completedTime}</td>
    `;
    completedTable.appendChild(row);
}

/* ---------- CSV ---------- */
function downloadCSV() {
    let csv = "Date,Store,Name,Reg,Supplier,Defect,Solution,Completed\n";
    completedJobs.forEach(j => {
        csv += `"${j.date}","${j.store}","${j.name}","${j.reg}","${j.supplier}","${j.defect}","${j.solution}","${j.completedTime}"\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "completed_jobs.csv";
    a.click();
}

/* ---------- RESET ---------- */
function resetCompletedJobs() {
    if (!confirm("Clear all completed jobs for everyone?")) return;
    db.ref("completedJobs").remove();
}
</script>

</body>
</html>
