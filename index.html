<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vehicle Defect Log</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 20px;
}
h1, h2 {
    margin-top: 30px;
}
form, .log, table {
    background: #fff;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}
input, textarea, button {
    width: 100%;
    margin: 5px 0;
    padding: 8px;
}
button {
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
}
button.complete {
    background: #28a745;
}
.log {
    border-left: 5px solid #007bff;
}
.timer {
    font-weight: bold;
    color: #c00;
}
.laps {
    font-size: 0.9em;
    color: #555;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    border: 1px solid #ccc;
    padding: 8px;
}
th {
    background: #eee;
}
</style>
</head>

<body>

<h1>Vehicle Log System</h1>

<form id="logForm">
    <input id="date" type="date" required>
    <input id="store" placeholder="Store No" required>
    <input id="name" placeholder="Name" required>
    <input id="reg" placeholder="Reg No" required>
    <input id="supplier" placeholder="Supplier" required>
    <textarea id="defect" placeholder="What is wrong with van?" required></textarea>
    <textarea id="solution" placeholder="Solution?" required></textarea>
    <button type="submit">Add Log</button>
</form>

<h2>Active Logs</h2>
<div id="logs"></div>

<h2>Completed Jobs</h2>
<button onclick="downloadCSV()">Download Excel (CSV)</button>
<button onclick="resetCompletedJobs()" style="background:#dc3545;">
    Reset Completed Jobs
</button>

<table>
<thead>
<tr>
    <th>Date</th>
    <th>Store</th>
    <th>Name</th>
    <th>Reg</th>
    <th>Supplier</th>
    <th>Defect</th>
    <th>Solution</th>
    <th>Completed</th>
</tr>
</thead>
<tbody id="completedTable"></tbody>
</table>

<!-- Alert sound -->
<audio id="alarmSound">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const logsDiv = document.getElementById("logs");
const completedTable = document.getElementById("completedTable");
const alarmSound = document.getElementById("alarmSound");

let completedJobs = JSON.parse(localStorage.getItem("completedJobs")) || [];
completedJobs.forEach(addCompletedRow);

document.getElementById("logForm").addEventListener("submit", e => {
    e.preventDefault();

    const log = {
        date: date.value,
        store: store.value,
        name: name.value,
        reg: reg.value,
        supplier: supplier.value,
        defect: defect.value,
        solution: solution.value,
        start: Date.now(),
        laps: 0
    };

    createLog(log);
    e.target.reset();
});

function createLog(log) {
    const div = document.createElement("div");
    div.className = "log";

    const timerSpan = document.createElement("div");
    timerSpan.className = "timer";

    const lapSpan = document.createElement("div");
    lapSpan.className = "laps";
    lapSpan.textContent = "30min checks: 0";

    let startTime = Date.now();

    const interval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const remaining = 1800000 - elapsed;

        if (remaining <= 0) {
            log.laps++;
            lapSpan.textContent = `30min checks: ${log.laps}`;
            alarmSound.play();
            startTime = Date.now(); // reset timer
        }

        const mins = Math.floor(Math.max(remaining, 0) / 60000);
        const secs = Math.floor((Math.max(remaining, 0) % 60000) / 1000);
        timerSpan.textContent = `â± ${mins}:${secs.toString().padStart(2, "0")}`;
    }, 1000);

    div.innerHTML = `
        <strong>Date:</strong> ${log.date}<br>
        <strong>Store:</strong> ${log.store}<br>
        <strong>Name:</strong> ${log.name}<br>
        <strong>Reg:</strong> ${log.reg}<br>
        <strong>Supplier:</strong> ${log.supplier}<br>
        <strong>Issue:</strong> ${log.defect}<br>
        <strong>Solution:</strong> ${log.solution}<br>
    `;

    const completeBtn = document.createElement("button");
    completeBtn.textContent = "Complete Job";
    completeBtn.className = "complete";

    completeBtn.onclick = () => {
        clearInterval(interval);

        const completed = {
            ...log,
            completedTime: new Date().toLocaleString()
        };

        completedJobs.push(completed);
        localStorage.setItem("completedJobs", JSON.stringify(completedJobs));
        addCompletedRow(completed);
        div.remove();
    };

    div.appendChild(timerSpan);
    div.appendChild(lapSpan);
    div.appendChild(completeBtn);

    logsDiv.appendChild(div);
}

function addCompletedRow(job) {
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${job.date}</td>
        <td>${job.store}</td>
        <td>${job.name}</td>
        <td>${job.reg}</td>
        <td>${job.supplier}</td>
        <td>${job.defect}</td>
        <td>${job.solution}</td>
        <td>${job.completedTime}</td>
    `;
    completedTable.appendChild(row);
}

function downloadCSV() {
    let csv = "Date,Store,Name,Reg,Supplier,Defect,Solution,Completed\n";
    completedJobs.forEach(j => {
        csv += `"${j.date}","${j.store}","${j.name}","${j.reg}","${j.supplier}","${j.defect}","${j.solution}","${j.completedTime}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "completed_jobs.csv";
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>

